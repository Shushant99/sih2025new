<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Smart Attendance</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    .status-active { color: #38a169; font-weight: bold; }
    .status-inactive { color: #e53e3e; font-weight: bold; }
    .user-table { font-size: 14px; }
    .login-time { font-size: 12px; color: #718096; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="nav-header">
        <div>
          <h1>⚙️ Administrator Dashboard</h1>
          <p class="user-info">Logged in as: {{ session.userid }}</p>
        </div>
        <div>
          <a href="{{ url_for('index') }}" class="btn btn-primary">🏠 Home</a>
          <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
      </div>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <ul class="flash-messages">
            {% for msg in messages %}
              <li class="{% if 'success' in msg.lower() %}flash-success{% endif %}">{{ msg }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <!-- System Statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-number">{{ total_users }}</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ total_teachers }}</div>
          <div class="stat-label">Teachers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ total_admins }}</div>
          <div class="stat-label">Admins</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ total_classes }}</div>
          <div class="stat-label">Classes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ reports|length if reports else 0 }}</div>
          <div class="stat-label">Reports</div>
        </div>
      </div>

      <!-- User Management Section -->
      <h2>👥 User Management & Login Activity</h2>
      <div class="dashboard-grid">
        
        <div class="feature-card">
          <div class="feature-icon">👥</div>
          <h3>Student Management</h3>
          <p>Register new students, upload sample images, and manage student data</p>
          <a href="{{ url_for('upload_samples') }}" class="btn btn-success">Add Students</a>
        </div>

        <div class="feature-card">
          <div class="feature-icon">👨‍🏫</div>
          <h3>User Management</h3>
          <p>Create teacher accounts, assign classes, and manage user permissions</p>
          <a href="{{ url_for('add_teacher') }}" class="btn btn-warning">Add Teachers</a>
        </div>

        <div class="feature-card">
          <div class="feature-icon">📊</div>
          <h3>Reports & Analytics</h3>
          <p>View attendance reports, generate analytics, and export data</p>
          <a href="{{ url_for('view_attendance') }}" class="btn btn-primary">View Reports</a>
        </div>

        <div class="feature-card">
          <div class="feature-icon">🔍</div>
          <h3>System Monitor</h3>
          <p>Track user activity, login history, and system usage</p>
          <div style="margin-top: 15px;">
            <p style="color: #718096; font-size: 14px;">View details in table below</p>
          </div>
        </div>

      </div>

      <!-- User Login Details Table -->
      <h3>👩‍🏫 User Accounts & Login Activity</h3>
      <div class="table-container">
        <table class="user-table">
          <thead>
            <tr>
              <th>👤 User ID</th>
              <th>🎭 Role</th>
              <th>🏫 Class</th>
              <th>📊 Status</th>
              <th>🕐 Last Login</th>
              <th>🔢 Logins</th>
              <th>🔧 Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in user_list %}
            <tr>
              <td><strong>{{ user.userid }}</strong></td>
              <td>
                {% if user.role == 'admin' %}
                  <span style="color: #e53e3e;">🔐 {{ user.role|title }}</span>
                {% else %}
                  <span style="color: #38a169;">👨‍🏫 {{ user.role|title }}</span>
                {% endif %}
              </td>
              <td>
                {% if user.class != 'N/A' %}
                  <span style="color: #667eea;">{{ user.class }}</span>
                {% else %}
                  <span style="color: #a0aec0;">{{ user.class }}</span>
                {% endif %}
              </td>
              <td>
                <span class="status-{{ user.status|lower }}">
                  {% if user.status == 'Active' %}🟢{% else %}🔴{% endif %} {{ user.status }}
                </span>
              </td>
              <td>
                {% if user.last_login != 'Never' %}
                  <div>{{ user.last_login.split(' ')[0] }}</div>
                  <div class="login-time">{{ user.last_login.split(' ')[1] }}</div>
                  <div class="login-time">{{ user.last_login_display.split('(')[1].rstrip(')') if '(' in user.last_login_display else '' }}</div>
                {% else %}
                  <span style="color: #a0aec0;">Never logged in</span>
                {% endif %}
              </td>
              <td style="text-align: center;">
                <span style="font-weight: bold; color: #667eea;">{{ user.login_count }}</span>
              </td>
              <td>
                {% if user.role == 'teacher' %}
                  <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #ed8936;" 
                          onclick="resetUserPassword('{{ user.userid }}')">🔄 Reset</button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Recent Reports -->
      {% if reports %}
      <h3>📋 Recent Reports</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>📄 Report Name</th>
              <th>📅 Date</th>
              <th>🔗 Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports[:5] %}
            <tr>
              <td>{{ report }}</td>
              <td>
                {% set date_part = report.split('_')[-2] if '_' in report else 'Unknown' %}
                {{ date_part }}
              </td>
              <td>
                <a href="{{ url_for('download_report', filename=report) }}" class="btn btn-primary" style="padding: 5px 15px; font-size: 14px;">📥 Download</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

    </div>
  </div>

  <script>
    function resetUserPassword(userid) {
      if (confirm(`Reset password for user: ${userid}?\nThis will generate a new temporary password.`)) {
        // You can implement password reset functionality here
        alert(`Password reset for ${userid} - Feature coming soon!`);
      }
    }

    // Auto-refresh page every 5 minutes to update login times
    setTimeout(() => {
      location.reload();
    }, 300000); // 5 minutes
  </script>
</body>
</html>
